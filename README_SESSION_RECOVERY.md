# תכונת שחזור סשן פעיל (Session Recovery)

## תיאור התכונה

תכונה חדשה שמאפשרת למשתמש לחזור לדף פרויקט ולמצוא את הסשן הפעיל ממשיך לרוץ בדיוק מהמקום שעזב.

## מה חדש?

- **בדיקה אוטומטית**: בעת טעינת הדף, המערכת בודקת אם יש סשן פעיל או מושהה
- **המשכת סטופר**: הסטופר ממשיך לרוץ מהזמן הנכון ולא מתאפס
- **שחזור כפתורים**: הכפתור "התחל/השהה/המשך" מתעדכן אוטומטית לפי המצב הנוכחי
- **שחזור בר התקדמות**: בר ההתקדמות מתעדכן לפי הזמן שכבר עבר

## קבצים ששונו

### צד שרת (C#):

1. **SessionController.cs** - נוספה מתודה `CheckActiveSession`
2. **Session.cs** - נוספה מתודה `GetActiveSession`
3. **DBservices.cs** - נוספה מתודה `GetActiveSession`

### צד לקוח (JavaScript):

1. **projectPage.js** - נוספה פונקציה `checkActiveSessionOnPageLoad`

### מסד נתונים:

1. **SQL_StoredProcedure_GetActiveSession.sql** - פרוצדורה חדשה לבדיקת סשן פעיל

## התקנה והפעלה

### שלב 1: הרצת הפרוצדורה ב-SQL Server

```sql
-- הרץ את הקובץ SQL_StoredProcedure_GetActiveSession.sql במסד הנתונים
USE [שם_מסד_הנתונים_שלך]
GO

-- התוכן של הפרוצדורה כבר נמצא בקובץ SQL_StoredProcedure_GetActiveSession.sql
```

### שלב 2: הרצת השרת

```bash
# וודא שהשרת רץ על הפורט 7198
cd Server
dotnet run
```

### שלב 3: פתיחת הלקוח

```bash
# פתח את הקובץ projectPage.html בדפדפן
# או השתמש בשרת מקומי
```

## איך לבדוק שהתכונה עובדת?

### בדיקה 1: סשן פעיל (Active)

1. היכנס לעמוד פרויקט
2. לחץ על "התחל סשן"
3. הסטופר יתחיל לרוץ והכפתור ישתנה ל"השהה"
4. **רענן את הדף** או סגור וחזור
5. ✅ **צפוי**: הסטופר ימשיך לרוץ מהזמן הנכון והכפתור יהיה "השהה"

### בדיקה 2: סשן מושהה (Paused)

1. היכנס לעמוד פרויקט
2. לחץ על "התחל סשן"
3. לחץ על "השהה" אחרי כמה שניות
4. **רענן את הדף** או סגור וחזור
5. ✅ **צפוי**: הסטופר יעצור בזמן הנכון והכפתור יהיה "המשך"

### בדיקה 3: אין סשן פעיל

1. היכנס לעמוד פרויקט (בלי סשן פעיל)
2. **רענן את הדף**
3. ✅ **צפוי**: הכפתור יהיה "התחל" והסטופר יהיה 00:00:00

## הודעות לוג בקונסול

בעת בדיקה, פתח את Developer Tools (F12) ובחר ב-Console. אמורות להופיע הודעות כמו:

```
🔍 בודק אם יש סשן פעיל בעת טעינת הדף...
📊 תשובה מבדיקת סשן פעיל: {hasActiveSession: true, sessionData: {...}}
⏰ נמצא סשן פעיל! עברו 127 שניות מההתחלה
▶️ הסטופר התחיל אוטומטית - סשן פעיל
✅ סטטוס הסשן הפעיל שוחזר בהצלחה!
```

או אם אין סשן פעיל:

```
🔍 בודק אם יש סשן פעיל בעת טעינת הדף...
📊 תשובה מבדיקת סשן פעיל: {hasActiveSession: false}
ℹ️ אין סשן פעיל - הכפתור יישאר במצב 'התחל'
```

## API החדש

### GET /api/Session/CheckActiveSession

**פרמטרים:**

- `userID` (int) - מזהה המשתמש
- `projectID` (int) - מזהה הפרויקט

**תשובה:**

```json
{
  "hasActiveSession": true,
  "sessionData": {
    "SessionID": 123,
    "ProjectID": 456,
    "StartDate": "2024-01-15T10:30:00",
    "SessionStatus": "Active",
    "HourlyRate": 100.0
    // ... נתונים נוספים
  }
}
```

או אם אין סשן פעיל:

```json
{
  "hasActiveSession": false
}
```

## פתרון בעיות נפוצות

### הסטופר לא ממשיך לרוץ אחרי רענון

- בדוק שהפרוצדורה `sp_ET_GetActiveSession` הותקנה נכון במסד הנתונים
- בדוק את הקונסול לשגיאות JavaScript
- וודא שהשרת רץ ומגיב על פורט 7198

### הכפתור לא משתנה למצב הנכון

- בדוק שהערכים `CurrentUser.id` ו-`CurrentProject.ProjectID` קיימים ב-localStorage
- בדוק שאין שגיאות ברשת בקונסול

### בר ההתקדמות לא מתעדכן

- וודא ש-`totalPastSeconds` מחושב נכון
- בדוק שהפונקציה `renderTableFromDB` רצה לפני בדיקת הסשן הפעיל

## טכנולוגיות בשימוש

- **Backend**: ASP.NET Core Web API
- **Frontend**: Vanilla JavaScript + jQuery
- **Database**: SQL Server + Stored Procedures
- **Session Management**: פרוצדורות SQL מותאמות אישית

---

**נוצר על ידי:** Claude Assistant  
**תאריך:** ינואר 2024
